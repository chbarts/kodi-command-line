#!/usr/bin/env zsh

kodi_loc='odroid.local:8080'

if [[ $# -eq 0 ]]; then
    echo "usage: $0 MEDIA-FILE-NAME"
    exit 0
fi

if [[ "$@" =~ '^[[:alpha:]]+://' ]]; then
    if [[ "$@" =~ '://(www\.)?youtu' ]]; then
        videoid=$(echo "$@" | grep -Po '[[:alnum:]_-]+$')
        curl -X POST -H 'Content-Type: application/json' http://$kodi_loc/jsonrpc\?awx --data-ascii  '{"jsonrpc": "2.0", "method": "Player.Open", "params" : { "item" : { "file" : "plugin://plugin.video.youtube/?path=/root/video&action=play_video&videoid='$videoid'"}, "options": { "resume": false } }, "id": 1}'
        exit 0
    fi
    
    curl -X POST -H 'Content-Type: application/json' http://$kodi_loc/jsonrpc\?awx --data-ascii  '{"jsonrpc": "2.0", "method": "Player.Open", "params" : { "item" : { "file" : "'"$@"'"}, "options": { "resume": false } }, "id": 1}'
    exit 0
fi

ext=${@##*.}

if [[ $ext = 'url' ]]; then
    url=$(cat "$@")
    curl -X POST -H 'Content-Type: application/json' http://$kodi_loc/jsonrpc\?awx --data-ascii  '{"jsonrpc": "2.0", "method": "Player.Open", "params" : { "item" : { "file" : "'$url'"}, "options": { "resume": false } }, "id": 1}'
    exit 0
fi

tnam="kodi-play.$ext"

if [[ -h ~/video/$tnam ]]; then
    rm ~/video/$tnam
fi

if [[ -e ~/video/$tnam ]]; then
    echo "$0: Temp file exists and is not a symbolic link" > /dev/stderr
    exit 1
fi

ln -s "$(realpath -- "$@")" ~/video/$tnam

myIP=$(ip route get 1 | awk '{print $NF;exit}')

curl -X POST -H 'Content-Type: application/json' http://$kodi_loc/jsonrpc\?awx --data-ascii  '{"jsonrpc": "2.0", "method": "Player.Open", "params" : { "item" : { "file" : "smb://'$myIP'/public/'$tnam'"}, "options": { "resume": false } }, "id": 1}'
